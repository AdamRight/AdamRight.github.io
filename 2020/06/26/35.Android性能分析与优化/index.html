<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Hexo">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->





<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>Android性能分析与优化 | Hexo</title>


    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    

</head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(http://snippet.shenliyang.com/img/banner.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='John Doe'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 士不可以不弘毅，任重而道远 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">Hexo</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Android/"><i class="fa "></i>Android</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Web/"><i class="fa "></i>Web</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/Java/"><i class="fa "></i>Java</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/C/"><i class="fa "></i>C</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Android性能分析与优化">
            
	            Android性能分析与优化
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/Android">
            Android
        </a>
    </span>
    

    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/性能" title='性能'>
                        性能
                    </a>
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2020/06/26</span>
        </span>
        
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <h2 id="1、启动优化"><a href="#1、启动优化" class="headerlink" title="1、启动优化"></a>1、启动优化</h2><h3 id="1-1、启动类型"><a href="#1-1、启动类型" class="headerlink" title="1.1、启动类型"></a>1.1、启动类型</h3><hr>
<p>冷启动流程：用户点击 -&gt; IPC -&gt; Process.start创建进程 -&gt; ActivityThread(单独进程的入口) -&gt; bindApplication(创建Application) -&gt; LifeCycle(Activity) -&gt; ViewRootImpl界面绘制</p>
<p>冷启动之前会进行的操作：启动App，加载空白Window，创建进程。随后会创建Application，启动主线程，创建Activity，加载布局，布置屏幕，首帧绘制。主要对Application和Activity生命周期进行优化。</p>
<p>热启动：后台切换到前台。</p>
<p>温启动：只会重走Activity的生命周期。</p>
<hr>
<h3 id="1-2、启动时间"><a href="#1-2、启动时间" class="headerlink" title="1.2、启动时间"></a>1.2、启动时间</h3><hr>
<p>1、adb方式：</p>
<pre><code>adb shell am start -W 包名/包名.首屏Activity

ThisTime:最后一个Activity启动耗时
TotalTime：所有Activity启动耗时
WaitTime：AMS启动Activity的总耗时
</code></pre><p>2、手动打点方式：启动时埋点，可以线上使用</p>
<p>开始时间Application</p>
<pre><code>@Override
protected void attachBaseContext(Context base) {
    super.attachBaseContext(base);
    //开始计时
}
</code></pre><p>结束计时</p>
<pre><code>//Activity中
@Override
public void onWindowFocusChanged(boolean hasFocus) {
    super.onWindowFocusChanged(hasFocus);
    //结束计时
}

//或者Adapter
@Override
public void onBindViewHolder(@NonNull final ViewHolder holder, int position) {
    if (position == 0 &amp;&amp; !mHasRecorded) {
        mHasRecorded = true;
        holder.layout.getViewTreeObserver()
                .addOnPreDrawListener(new ViewTreeObserver.OnPreDrawListener() {
                    @Override
                    public boolean onPreDraw() {
                        //结束计时
                        return true;
                    }
                });
    }
}
</code></pre><hr>
<h3 id="1-3、工具"><a href="#1-3、工具" class="headerlink" title="1.3、工具"></a>1.3、工具</h3><hr>
<p>traceview:图形展示执行时间、调用栈；包含所有线程。缺点：运行变慢。</p>
<pre><code>android.os.Debug.startMethodTracing();//也可以调用startMethodTracing(String traceName) 设置trace文件的文件名
android.os.Debug.stopMethodTracing();//放在结束调试的地方
生成文件在：Android/data/包名/files
</code></pre><p>systrace：结合Android内核的数据，生成Html报告。轻量级，开销小。直接反应cpu利用率。</p>
<pre><code>//b:大小，t:时间，o：生成文件名字
python systrace.py -b 32768 -t 5 -a 包名 -o html文件 sched gfx view wm am app

//项目代码
TraceCompat.beginSection(mTask.getClass().getSimpleName());
TraceCompat.endSection();
</code></pre><p><strong>cputime代码消耗cpu的时间（重要指标）；walltime：代码执行时间。</strong></p>
<hr>
<h3 id="1-4、统计方法消耗时间"><a href="#1-4、统计方法消耗时间" class="headerlink" title="1.4、统计方法消耗时间"></a>1.4、统计方法消耗时间</h3><hr>
<p>AOP：针对同一类问题统一处理。</p>
<p>AspectJ</p>
<pre><code>https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx

classpath &apos;com.hujiang.aspectjx:gradle-android-plugin-aspectjx:2.0.0&apos;
apply plugin: &apos;android-aspectjx&apos;
implementation &apos;org.aspectj:aspectjrt:1.8.+&apos;

例如PerformanceAop类
</code></pre><hr>
<h3 id="1-4、Theme小技巧"><a href="#1-4、Theme小技巧" class="headerlink" title="1.4、Theme小技巧"></a>1.4、Theme小技巧</h3><hr>
<p>Theme切换：感觉上更快。</p>
<p>drawable下创建.xml</p>
<pre><code>&lt;layer-list xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:opacity=&quot;opaque&quot;&gt;
    &lt;!-- The background color, preferably the same as your normal theme --&gt;
    &lt;item android:drawable=&quot;@android:color/white&quot;/&gt;
    &lt;!-- Your product logo - 144dp color version of your app icon --&gt;
    &lt;item&gt;
        &lt;bitmap
            android:src=&quot;@mipmap/splash&quot;
            android:gravity=&quot;fill&quot;/&gt;
    &lt;/item&gt;
&lt;/layer-list&gt;
</code></pre><p>styles中设置</p>
<pre><code>&lt;item name=&quot;android:windowBackground&quot;&gt;@drawable/lanucher&lt;/item&gt;
</code></pre><p>首屏Activity引用</p>
<pre><code>android:theme=&quot;@style/Theme.Splash&quot;
</code></pre><p>Activity中</p>
<pre><code>setTheme(R.style.AppTheme);
//super.onCreate之前切换真正的style
super.onCreate(savedInstanceState);
</code></pre><hr>
<h3 id="1-5、异步解决方案-启动器"><a href="#1-5、异步解决方案-启动器" class="headerlink" title="1.5、异步解决方案-启动器"></a>1.5、异步解决方案-启动器</h3><hr>
<p>异步优化：子线程分担主线程任务。</p>
<p>Application中的sdk初始化如果不需要再主线程中执行，那么就异步执行。CountDownLatch。</p>
<p>线程池创建线程数，根据手机cup</p>
<pre><code>private static final int CPU_COUNT = Runtime.getRuntime().availableProcessors();
private static final int CORE_POOL_SIZE = Math.max(2, Math.min(CPU_COUNT - 1, 4));
</code></pre><p>启动器：充分利用cpu多核，自动梳理任务顺序</p>
<p>代码Task化，启动逻辑抽象为Task。根据任务依赖关系排序生成一个有向无环图。多线程按照排序后的优先级依次执行。</p>
<p>工具类：TaskDispatcher，例子：主线程Task：InitWeexTask；子线程Task：InitAMapTask；等待Task：InitJPushTask。</p>
<p>延迟初始化：在MainActivity的onFeedShow方法中调用DelayInitDispatcher利用addIdleHandler</p>
<hr>

    </div>
    
        <div class="reward">
    <div class="reward-wrap">赏
        <div class="reward-box">
            
                <span class="reward-type">
                    <img class="alipay" src="../../../../img/reward-alipay.jpg"><b>支付宝打赏</b>
                </span>
            
            
                <span class="reward-type">
                    <img class="wechat" src="../../../../img/reward-wepay.jpg"><b>微信打赏</b>
                </span>
            
        </div>
    </div>
    <p class="reward-tip">赞赏是不耍流氓的鼓励</p>
</div>


    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Snippet</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2020/07/04/38.git/" class="pre-post btn btn-default" title='Git'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Git</span>
        </a>
    
    
        <a href="/2020/06/13/34.HTTP和加密和HTTPS/" class="next-post btn btn-default" title='HTTP和加密和HTTPS'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">HTTP和加密和HTTPS</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>






                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、启动优化"><span class="toc-text">1、启动优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1、启动类型"><span class="toc-text">1.1、启动类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2、启动时间"><span class="toc-text">1.2、启动时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3、工具"><span class="toc-text">1.3、工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4、统计方法消耗时间"><span class="toc-text">1.4、统计方法消耗时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4、Theme小技巧"><span class="toc-text">1.4、Theme小技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5、异步解决方案-启动器"><span class="toc-text">1.5、异步解决方案-启动器</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>